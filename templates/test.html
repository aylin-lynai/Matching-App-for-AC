<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Test Page</title>
<link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>
<div class="container">
    <div class="left-side">
        <div id="imageContainer">
            <img src="" id="memeImage" alt="Meme Image">
        </div>
        <div>
            <video id="cameraFeed" width="640" height="480" autoplay></video>
        </div>
    </div>
        
    <div class="right-side">
        <h1>TestPicture</h1>
        <button id="nextButton">Next</button>
        <button id="resultButton">Jump to Result</button>
    </div>
</div>
<script>
document.getElementById('resultButton').addEventListener('click', function() {
    window.location.href = '/resultpage'; // jump to Resultpage
});

document.addEventListener('DOMContentLoaded', function() {
    const nextButton = document.getElementById('nextButton');
    let availableImages = [];
    let clickCount = 0;
    let currentImageIndex = 0; // Initialize currentImageIndex

    // Access the user's webcam
    const cameraFeed = document.getElementById('cameraFeed');
    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        navigator.mediaDevices.getUserMedia({ video: true }).then(function(stream) {
            cameraFeed.srcObject = stream;
            cameraFeed.play();
        });
    }

    fetch('/reacted_images')
        .then(response => response.json())
        .then(reactedImages => {
            const images = ['1.jpg', '2.jpg', '3.jpg', '4.jpg', '5.jpg', '6.jpg', '7.jpg', '8.jpg', '9.jpg', '10.jpg', 
                            '11.jpg', '12.jpg', '13.jpg', '14.jpg', '15.jpg', '16.jpg', '17.jpg', '18.jpg', '19.jpg'];

            // Filter out reacted images
            availableImages = images.filter((_, index) => !reactedImages.includes(index + 1));

            // Initial display of the first image
            if (availableImages.length > 0) {
                displayImageByIndex(currentImageIndex);
            } else {
                window.location.href = '/resultpage'; // If no available images, redirect to result page
            }
        })
        .catch(error => {
            console.error('Error fetching reacted images:', error);
        });

    nextButton.addEventListener('click', function() {
        if (clickCount < availableImages.length) {
            displayImageByIndex(currentImageIndex); // Pass currentImageIndex to displayImageByIndex
            captureReaction(currentImageIndex); // Pass currentImageIndex to captureReaction
            currentImageIndex++;
            clickCount++;
        } else {
            window.location.href = '/resultpage'; // after all available images, jump to resultpage
        }
    });

    function displayImageByIndex(index) {
        if (index < availableImages.length) {
            const imgElement = document.getElementById('memeImage');
            imgElement.src = `{{ url_for('static', filename='images/memes/') }}` + availableImages[index];
        } else {
            window.location.href = '/resultpage'; // After showing all available images, jump to result page
        }
    }

    function captureReaction(index) {
        const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');
        canvas.width = cameraFeed.videoWidth;
        canvas.height = cameraFeed.videoHeight;
        context.drawImage(cameraFeed, 0, 0, canvas.width, canvas.height);
        const imageData = canvas.toDataURL('image/png');

        fetch('/capture_reaction', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ image_data: imageData, current_image_index: availableImages[index].split('.')[0] }), // Send current image index
        })
        .then(response => response.json())
        .then(data => {
            console.log('Success:', data);
        })
        .catch((error) => {
            console.error('Error:', error);
        });
    }

    // Display the first random image when the page loads
    displayRandomImage();
});
</script>
</body>
</html>
